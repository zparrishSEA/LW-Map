<!DOCTYPE html>
<html>
<head>
    <title>Master Map: Multi-Sheet & Auto-Fix Headers</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: 'Segoe UI', Tahoma, sans-serif; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 320px; background: #fff; border-right: 1px solid #ccc; display: flex; flex-direction: column; z-index: 1001; }
        .logo-container { padding: 15px; text-align: center; border-bottom: 1px solid #eee; background: #fafafa; }
        .company-logo { max-width: 130px; height: auto; }
        #map { flex-grow: 1; position: relative; }
        .leaflet-control-layers { max-width: 250px; font-size: 11px !important; background: rgba(255, 255, 255, 0.9) !important; box-shadow: 0 0 15px rgba(0,0,0,0.2) !important; border-radius: 8px !important; }
        .leaflet-control-layers-overlays label { margin-bottom: 2px !important; }
        .layer-desc { display: block; font-size: 9px; color: #777; margin-left: 22px; line-height: 1.1; }
        .marker-count { color: #007bff; font-weight: bold; }
        .sidebar-header { padding: 15px; border-bottom: 1px solid #eee; }
        .search-box { width: 100%; padding: 8px; border-radius: 20px; border: 1px solid #ccc; outline: none; }
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        button { flex: 1; padding: 8px; border-radius: 20px; border: none; background: #007bff; color: white; cursor: pointer; font-size: 11px; }
        #resultsList { flex-grow: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .result-item { padding: 10px 15px; border-bottom: 1px solid #eee; cursor: pointer; font-size: 13px; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div class="logo-container">
            <img src="https://lh3.googleusercontent.com/d/1dACXmZYFekAADTN5peF2Z6KxXRelDvv1" alt="Logo" class="company-logo">
        </div>
        <div class="sidebar-header">
            <input type="text" id="mapSearch" class="search-box" placeholder="Search data...">
            <div class="btn-group">
                <button id="btnSearch">Search</button>
                <button id="btnReset" style="background:#6c757d;">Reset View</button>
            </div>
        </div>
        <ul id="resultsList"></ul>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

    <script>
        const map = L.map('map').setView([20, 0], 2);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }).addTo(map);

        const allMarkers = [];
        const markerGroup = L.featureGroup().addTo(map);

        // Track counts globally for multi-sheet layers (like Step 0)
        const sheetCounts = {};

        let sheets = [
            {
                name: "Step 0",
                desc: "Under 10 Signatures",
                color: "#ABABAB",
                urls: [
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vRMii-mD_nfqLN4g6LkP1T2D8qFD2VE2KhEpsDMo8P5JqELjYzAzQmna7EFqLkgZL4MqbVq9QzBRyQW/pub?output=csv",
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSn0_v9d45f1-qsbK56zofHPyjVH0NEodOSmuexGt-D0eAEjyhCv_sXh8o11Vo2kzHozXS1mscFQ9Js/pub?output=csv",
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQXnmM1UDBJsZT66GmP9C2C9GzTK7pHrKNZn9ZZltQurpfQ3qlyRANWxQWGH5K6fsgwXw0TkXysk_ZJ/pub?output=csv",
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vSaa8gDF6ng1E8YUJ-THYsfHZ4M28y91nGpASy5GHfmfgISsXoP_XmswOEhZeYW8FHVsxzE1gh-Dstf/pub?output=csv",
                    "https://docs.google.com/spreadsheets/d/e/2PACX-1vQN6RMquGyImew2ZpR_-k-habAJSR0bgJO58Q3FhSgMaJdavS_QTVJjnnhXyUpRq8_t1QVpnmsFx8ig/pub?output=csv"
                ]
            },
            { name: "Step 1", desc: "10-50 Signatures", color: "#2E85DB", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTzJpeI6tIzbJ2EEs7hXP5AB0y2-Y0xZtvtZQu7Pv55gYrg8vCmwKNZnzam_W4KjY6JxbSM2W0E4Tj/pub?output=csv" },
            { name: "Step 2", desc: "Community Kickoff Meeting", color: "#ACDBB0", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRTnYrjWo0CCwhgbPCqHMCOE4td62A9zdq97d6zkDNlFaSSC0je1ID5qCfZ0gUxly_FeDg06NYbjBhH/pub?output=csv" },
            { name: "Step 3", desc: "Raise $500", color: "#25DB20", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vR5F0lL2gP5fujfLazuAAu6-HyTTdH_APQ53BXOygvz5QxZUbPmibFCLVZkLqTmj1bp1dDy5X7hJ-se/pub?output=csv" },
            { name: "Step 4", desc: "Form Local Steering Committee", color: "#00FFA0", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQj-xjmLdJ9Uemt4tdbtbr75QNZVp5C19dYNiKkocutLxA4oHjeiwYjVNoDrXS278WWGKITZ0mCWzDw/pub?output=csv" },
            { name: "Step 5", desc: "Draft A Plan", color: "#B0A122", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vReQNENdd47Fj4WRl-56WH1RzfOS_ZMMsD3zIlRMzLRnrxnUEdazAt7jrL--u3E6sSL3dfkiBKqlxU7/pub?output=csv" },
            { name: "Step 6", desc: "Obtain School Approval", color: "#FFCB00", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vQyKG0veTaCk1pgKISO-qJonQLYZBxYprsHpt9j_Hh64L0XzZJk8IvZ6znEf2_YsgtKMbWOSsskkG8e/pub?output=csv" },
            { name: "Step 7", desc: "Recruit Your Team", color: "#FFD0A2", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vTotWVs9_F99p8CO-JA18RrnAhUXLbAM-C--2tMh-Xp9aShvwO6fJAO80J7rIs8WrbpyVmdF7FojsyG/pub?output=csv" },
            { name: "Step 8", desc: "Train Your Team", color: "#FC80FF", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vRycSZF-EW5KiNHdqBbAlSj8fcvU8IGdfej7Iwr4iYQNGJko_OlaAD67SECzfN0od_Q5BKJekwg2Pa8/pub?output=csv" },
            { name: "Step 9", desc: "Execute Your Plan", color: "#FA5188", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSzWNJx52SA-lsyLtOAfw-KZmw3x7vvbmWvp6D670GEgpbaitB8ylH9zKV1Xwc_76niUvuKIgDRlUUB/pub?output=csv" },
            { name: "Step 10", desc: "Live LifeWise Program", color: "#FF0004", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vT_UXNj1Uc9qQOD8e0Bou-eFkzLHYY0rPQEgaRnlfBoXMxE_ZmW29gK46Dgvf1tz8qbMl2-MbyoYHKp/pub?output=csv" },
            { name: "Step 11", desc: "Mature LifeWise Program", color: "#420102", url: "https://docs.google.com/spreadsheets/d/e/2PACX-1vSIEKicXubtMmQ2HgDKNqITU-M_6WtG6Agqv44XLGbPLNckcZuM8q7P9eQIKf3-QadEkoLtARW7M2LJ/pub?output=csv" }
        ];

        sheets.sort((a, b) => a.name.localeCompare(b.name, undefined, { numeric: true }));

        const layerControl = L.control.layers(null, null, { collapsed: false, position: 'bottomright' }).addTo(map);

        // Pre-initialize layer groups and legend
        sheets.forEach(sheet => {
            sheet.layerGroup = L.layerGroup().addTo(map);
            sheetCounts[sheet.name] = 0;
            const label = `<b style="color:${sheet.color}">${sheet.name}</b> <span id="count-${sheet.name.replace(/\s+/g, '')}" class="marker-count">(...)</span><span class="layer-desc">${sheet.desc}</span>`;
            layerControl.addOverlay(sheet.layerGroup, label);
        });

        async function loadSheet(sheet, specificUrl) {
            const urlToUse = specificUrl || sheet.url;
            const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(urlToUse);
            try {
                const response = await fetch(proxyUrl);
                const csvText = await response.text();
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        results.data.forEach(row => {
                            // FUZZY HEADER FIX: Handles " LAT" or "lat" or "LON "
                            const latKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'LAT');
                            const lonKey = Object.keys(row).find(k => k.trim().toUpperCase() === 'LON');

                            const lat = parseFloat(row[latKey]);
                            const lon = parseFloat(row[lonKey]);

                            if (!isNaN(lat) && !isNaN(lon)) {
                                sheetCounts[sheet.name]++;
                                let table = `<table class="popup-table">`;
                                for (let key in row) { if (row[key]) table += `<tr><td><b>${key}</b></td><td>${row[key]}</td></tr>`; }
                                table += `</table>`;
                                const dot = L.circleMarker([lat, lon], {
                                    radius: 5, fillColor: sheet.color, color: "#fff", weight: 1, fillOpacity: 0.8
                                }).bindPopup(table);
                                dot.addTo(sheet.layerGroup);
                                dot.addTo(markerGroup);
                                allMarkers.push({ marker: dot, rowData: row, layerName: sheet.name, fullString: Object.values(row).join(" ").toLowerCase() });
                            }
                        });
                        const countEl = document.getElementById(`count-${sheet.name.replace(/\s+/g, '')}`);
                        if (countEl) countEl.innerHTML = `(${sheetCounts[sheet.name]})`;
                        if(markerGroup.getBounds().isValid()) map.fitBounds(markerGroup.getBounds(), {padding:[50,50]});
                    }
                });
            } catch (e) { console.error("Error loading sheet:", e); }
        }

        // START LOADING
        sheets.forEach(sheet => {
            if (sheet.urls) {
                // If multiple URLs (Step 0)
                sheet.urls.forEach(url => loadSheet(sheet, url));
            } else {
                // Single URL
                loadSheet(sheet);
            }
        });

        // UI Listeners
        document.getElementById('btnSearch').addEventListener('click', function() {
            const query = document.getElementById('mapSearch').value.toLowerCase().trim();
            const list = document.getElementById('resultsList');
            list.innerHTML = "";
            if (!query) return;
            const matches = allMarkers.filter(m => m.fullString.includes(query));
            matches.forEach(m => {
                const li = document.createElement('li');
                li.className = 'result-item';
                li.innerHTML = `<b>${Object.values(m.rowData)[0]}</b><br><small>${m.layerName}</small>`;
                li.onclick = () => { map.flyTo(m.marker.getLatLng(), 15); m.marker.openPopup(); };
                list.appendChild(li);
            });
        });

        document.getElementById('btnReset').addEventListener('click', () => {
            if(markerGroup.getBounds().isValid()) map.fitBounds(markerGroup.getBounds());
        });
    </script>
</body>
</html>